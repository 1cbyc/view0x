import { Request, Response } from "express";
import { Vulnerability } from "../models/Vulnerability";
import { VulnerabilityComment } from "../models/VulnerabilityComment";
import { Analysis } from "../models/Analysis";
import { User } from "../models/User";
import {
  NotFoundError,
  AuthorizationError,
  ValidationError,
} from "../middleware/errorHandler";
import { logger } from "../utils/logger";

/**
 * @description Create a comment on a vulnerability
 * @route POST /api/vulnerabilities/:vulnerabilityId/comments
 */
export const createComment = async (req: Request, res: Response) => {
  const { vulnerabilityId } = req.params;
  const userId = req.user?.userId;
  const { comment, lineNumber } = req.body;

  if (!comment || comment.trim().length === 0) {
    throw new ValidationError("Comment text is required.");
  }

  if (comment.length > 5000) {
    throw new ValidationError("Comment must be less than 5000 characters.");
  }

  const vulnerability = await Vulnerability.findByPk(vulnerabilityId);
  if (!vulnerability) {
    throw new NotFoundError("Vulnerability not found.");
  }

  // Check if user has access to the analysis this vulnerability belongs to
  const analysis = await Analysis.findByPk(vulnerability.analysisId);
  if (!analysis || analysis.userId !== userId) {
    throw new AuthorizationError("You are not authorized to comment on this vulnerability.");
  }

  const newComment = await VulnerabilityComment.create({
    vulnerabilityId,
    userId: userId!,
    comment: comment.trim(),
    lineNumber: lineNumber || null,
  });

  // Load with user info
  await newComment.reload({
    include: [
      {
        model: User,
        as: "user",
        attributes: ["id", "name", "email"],
      },
    ],
  });

  logger.info(`Comment created on vulnerability ${vulnerabilityId} by user ${userId}`);

  res.status(201).json({
    success: true,
    data: newComment,
  });
};

/**
 * @description Get all comments for a vulnerability
 * @route GET /api/vulnerabilities/:vulnerabilityId/comments
 */
export const getComments = async (req: Request, res: Response) => {
  const { vulnerabilityId } = req.params;
  const userId = req.user?.userId;

  const vulnerability = await Vulnerability.findByPk(vulnerabilityId);
  if (!vulnerability) {
    throw new NotFoundError("Vulnerability not found.");
  }

  // Check if user has access to the analysis
  const analysis = await Analysis.findByPk(vulnerability.analysisId);
  if (!analysis || analysis.userId !== userId) {
    throw new AuthorizationError("You are not authorized to view comments on this vulnerability.");
  }

  const comments = await VulnerabilityComment.findAll({
    where: { vulnerabilityId },
    include: [
      {
        model: User,
        as: "user",
        attributes: ["id", "name", "email"],
      },
    ],
    order: [["createdAt", "ASC"]],
  });

  res.json({
    success: true,
    data: comments,
  });
};

/**
 * @description Update a comment
 * @route PUT /api/vulnerabilities/comments/:commentId
 */
export const updateComment = async (req: Request, res: Response) => {
  const { commentId } = req.params;
  const userId = req.user?.userId;
  const { comment } = req.body;

  if (!comment || comment.trim().length === 0) {
    throw new ValidationError("Comment text is required.");
  }

  if (comment.length > 5000) {
    throw new ValidationError("Comment must be less than 5000 characters.");
  }

  const commentRecord = await VulnerabilityComment.findByPk(commentId);
  if (!commentRecord) {
    throw new NotFoundError("Comment not found.");
  }

  if (commentRecord.userId !== userId) {
    throw new AuthorizationError("You are not authorized to update this comment.");
  }

  commentRecord.comment = comment.trim();
  await commentRecord.save();

  logger.info(`Comment ${commentId} updated by user ${userId}`);

  res.json({
    success: true,
    data: commentRecord,
  });
};

/**
 * @description Delete a comment
 * @route DELETE /api/vulnerabilities/comments/:commentId
 */
export const deleteComment = async (req: Request, res: Response) => {
  const { commentId } = req.params;
  const userId = req.user?.userId;

  const commentRecord = await VulnerabilityComment.findByPk(commentId);
  if (!commentRecord) {
    throw new NotFoundError("Comment not found.");
  }

  if (commentRecord.userId !== userId) {
    throw new AuthorizationError("You are not authorized to delete this comment.");
  }

  await commentRecord.destroy();

  logger.info(`Comment ${commentId} deleted by user ${userId}`);

  res.status(204).send();
};
